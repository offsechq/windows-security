#Requires -RunAsAdministrator

$currentPrincipal = New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())
if (-not $currentPrincipal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Write-Host "ERROR: Run as Administrator" -ForegroundColor Red
    exit 1
}

Write-Host "Enabling Exploit Protection..." -ForegroundColor Cyan
Write-Host ""

# Download XML to temp if running remotely
$xmlUrl = "https://raw.githubusercontent.com/OFFSECHQ/windows-security/main/exploit-protection/exploit-protection-reset.xml"
$xmlPath = Join-Path $PSScriptRoot "exploit-protection-reset.xml"

if (-not (Test-Path $xmlPath)) {
    Write-Host "Downloading exploit-protection-reset.xml..." -ForegroundColor Yellow
    $xmlPath = Join-Path $env:TEMP "exploit-protection-reset.xml"
    Invoke-WebRequest -Uri $xmlUrl -OutFile $xmlPath -UseBasicParsing
}

Write-Host "Applying mitigation policy..." -ForegroundColor Yellow
Set-ProcessMitigation -PolicyFilePath $xmlPath

Write-Host ""
Write-Host "Exploit protection settings applied successfully." -ForegroundColor Green